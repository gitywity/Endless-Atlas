<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Endless Atlas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1>The Endless Atlas</h1>
            <div id="user-area" style="position: absolute; top: 20px; right: 20px;">
                <button id="login-btn" onclick="loginWithGoogle()" class="secondary-btn"
                    style="font-size: 0.8rem; cursor: pointer;">Login to Save</button>
                <span id="user-display" style="font-weight: bold; display: none; color: var(--text-main);"></span>
            </div>
        </header>

        <section id="game-controls" class="panel">
            <div class="controls-grid">
                <div class="control-item">
                    <label for="difficulty">Difficulty</label>
                    <div class="select-wrapper">
                        <select id="difficulty">
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                            <option value="Impossible">Impossible</option>
                        </select>
                    </div>
                </div>
                <div class="control-item">
                    <label for="region">Region</label>
                    <div class="select-wrapper">
                        <select id="region">
                            <option value="World">The World</option>
                            <option value="Asia">Asia</option>
                            <option value="Europe">Europe</option>
                            <option value="Americas">Americas</option>
                            <option value="Africa">Africa</option>
                            <option value="Oceania">Oceania</option>
                        </select>
                    </div>
                </div>
            </div>
            <button id="generate-btn" class="primary-btn">
                <span class="btn-text">Generate Question</span>
                <span class="loader hidden"></span>
            </button>
        </section>

        <main id="game-area" class="hidden">
            <div class="question-card">
                <div class="card-header">
                    <span class="badge" id="badge-difficulty">Easy</span>
                    <span class="badge" id="badge-region">Europe</span>
                </div>
                <h2 id="question-text">Question text will appear here...</h2>
            </div>

            <div id="options-grid" class="options-grid">
            </div>

            <div id="feedback-area" class="feedback-area hidden">
                <p id="feedback-text"></p>
                <button id="next-btn" class="secondary-btn">Next Question</button>
            </div>
        </main>
    </div>

    <script src="script.js"></script>

    <script type="module">
        // 1. We changed these links to import "Auth" and "Firestore" instead of Analytics
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Your Config (I kept your keys)
        const firebaseConfig = {
            apiKey: "AIzaSyCiEn69Uk4FW_zZePZd0pECVEka0od1-jQ",
            authDomain: "endless-atlas.firebaseapp.com",
            projectId: "endless-atlas",
            storageBucket: "endless-atlas.firebasestorage.app",
            messagingSenderId: "627615782733",
            appId: "1:627615782733:web:fd6c068de64eb0a8494904",
            measurementId: "G-7SE0D7SZSX"
        };

        // 3. Initialize the tools
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // 4. Listen for Auth Changes (Runs on load)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User detected:", user.email);
                document.getElementById("login-btn").style.display = "none";
                document.getElementById("user-display").style.display = "inline-block";
                // Use displayName (Google) or email (Email Auth)
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById("user-display").innerText = "Hi, " + name;
            } else {
                console.log("No user signed in");
            }
        });

        // 5. Make the Login function available to the button (if they aren't logged in)
        window.loginWithGoogle = async function () {
            try {
                const result = await signInWithPopup(auth, provider);
                // Listener above will handle the UI update
            } catch (error) {
                console.error("Login Error:", error);
                alert("Login failed. See console for details.");
            }
        };

        // 5. Make the Save Score function available to script.js
        window.saveScore = async function (points) {
            if (auth.currentUser) {
                try {
                    await addDoc(collection(db, "scores"), {
                        uid: auth.currentUser.uid,
                        name: auth.currentUser.displayName,
                        points: points,
                        timestamp: serverTimestamp()
                    });
                    console.log("Score Saved!");
                } catch (e) {
                    console.error("Error saving score:", e);
                }
            }
        };
    </script>
</body>

</html>